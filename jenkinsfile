pipeline {
    agent any
    	tools { 
		maven 'maven-3.6.2' 
		jdk 'JDK8' 
	    }	
	   parameters {
        choice(name: 'rama', choices: ['master', 'desarrollo'], description: 'Seleccionar la rama sobre la que realizar la integración')
    }
	stages{
		
		stage('Recursos') {
			steps {
				git url: 'https://github.com/jcintas/pruebaJenkinsfile.git', branch: "${params.rama}"
			}
		}
		
		
		stage('Configuracion sin Test') {
			steps {
				bat 'mvn install -DskipTests' 
			}
		}
		
		stage('Test Unitarios') {
			steps {
					bat 'mvn test' 
				}
				
			post {
				success {
					junit testResults: '**/target/surefire-reports/TEST-*.xml'
				}
			}
		  
		}
		
		stage('SonarQube analysis') { 
			when {
				expression { 
					"${params.rama}" == 'desarrollo' 
				}
			    }
			steps {
				withSonarQubeEnv('SonarCI') { 
				  bat 'mvn sonar:sonar ' + 
				  '-f ./pom.xml ' +
				  '-Dsonar.projectKey=cursoCImaven ' +
				  '-Dsonar.language=java ' +
				  '-Dsonar.sources=. ' +
				  '-Dsonar.tests=. ' +
				  '-Dsonar.java.binaries=./target/classes ' +
				  '-Dsonar.test.inclusions=**/*Test*/** ' +
				  '-Dsonar.exclusions=**/*Test*/**'
				}
			}
			
			post {
				failure {
					echo 'No se ha realizado correctamente el analisis del código en Sonar'
				}
			}
		}	
		
		
	}
}
